services:
  minecraft:
    build:
      context: .
      args:
        MC_VERSION: "1.21.4"
    image: lumo-server:latest
    container_name: lumo-minecraft
    ports:
      - "25565:25565"     # Minecraft
      - "25575:25575"     # RCON
      - "8100:8100"       # BlueMap
      - "24454:24454/udp" # Simple Voice Chat
    environment:
      EULA: "true"
      MEMORY: "4G"
      MOTD: "Welcome to the Lumo Universe!"
      RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
      # World setup is handled by the world-init service after server is healthy
    volumes:
      - minecraft-data:/data
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - minecraft-net

  world-init:
    build:
      context: ./docker/world-init
    image: lumo-world-init:latest
    container_name: lumo-world-init
    depends_on:
      minecraft:
        condition: service_healthy
    environment:
      RCON_HOST: minecraft
      RCON_PORT: 25575
      RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
    volumes:
      - minecraft-data:/data:ro
    networks:
      - minecraft-net
    restart: "no"

  rcon-web:
    image: itzg/rcon
    container_name: lumo-rcon-web
    ports:
      - "4326:4326"       # RCON Web UI
      - "4327:4327"       # WebSocket
    environment:
      RWA_USERNAME: admin
      RWA_PASSWORD: ${RCON_WEB_PASSWORD:-admin}
      RWA_ADMIN: "true"
      # Connection to Minecraft server
      RWA_RCON_HOST: minecraft
      RWA_RCON_PORT: 25575
      RWA_RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
    depends_on:
      - minecraft
    restart: unless-stopped
    networks:
      - minecraft-net

networks:
  minecraft-net:
    driver: bridge

volumes:
  minecraft-data:
