services:
  minecraft:
    build:
      context: .
      args:
        MC_VERSION: "1.21.4"
        BASE_IMAGE: "itzg/minecraft-server:java21"
    image: lumo-server:latest
    container_name: lumo-minecraft
    ports:
      - "25565:25565"     # Minecraft
      - "8100:8100"       # BlueMap
      - "24454:24454/udp" # Simple Voice Chat
    environment:
      # These can be overridden, defaults are in the Dockerfile
      MEMORY: "4G"
      WHITELIST: ""
      OPS: ""
      # RCON configuration for web admin
      RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
      ENABLE_RCON: "true"
      # Disable autopause so Chunker can pre-generate when no players online
      ENABLE_AUTOPAUSE: "false"
      # World setup is handled by the world-init service after server is healthy
    volumes:
      # World data persists outside the image
      - minecraft-data:/data
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - minecraft-net

  world-init:
    image: itzg/rcon-cli
    container_name: lumo-world-init
    depends_on:
      minecraft:
        condition: service_healthy
    environment:
      RCON_HOST: minecraft
      RCON_PORT: 25575
      RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
    volumes:
      - minecraft-data:/data:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "========================================"
        echo "  Lumo Server World Initialization"
        echo "========================================"
        echo ""

        # Function to check if world exists
        world_exists() {
          [ -d "/data/$$1" ]
        }

        # Function to create world if missing
        create_world() {
          world_name=$$1
          shift
          if world_exists "$$world_name"; then
            echo "[SKIP] World '$$world_name' already exists"
          else
            echo "[CREATE] Creating world '$$world_name'..."
            rcon-cli "mv create $$world_name $$@" || echo "[WARN] Failed to create $$world_name"
          fi
        }

        echo "--- Phase 1: Creating Worlds ---"
        create_world hub NORMAL -g VoidWorld
        create_world lumo_wilds NORMAL
        create_world lumo_wilds_nether NETHER
        create_world lumo_wilds_the_end THE_END
        create_world lumo_city NORMAL -g PlotSquared
        echo ""

        echo "--- Phase 2: Configuring Worlds ---"

        if world_exists hub; then
          echo "[CONFIG] Configuring hub..."
          rcon-cli "mvm set gamemode adventure hub"
          rcon-cli "mvm set difficulty peaceful hub"
          rcon-cli "mvm set pvp false hub"
        fi

        if world_exists lumo_wilds; then
          echo "[CONFIG] Configuring lumo_wilds..."
          rcon-cli "mvm set gamemode survival lumo_wilds"
          rcon-cli "mvm set difficulty hard lumo_wilds"
        fi

        if world_exists lumo_city; then
          echo "[CONFIG] Configuring lumo_city..."
          rcon-cli "mvm set gamemode survival lumo_city"
          rcon-cli "mvm set difficulty peaceful lumo_city"
          rcon-cli "mvm set pvp false lumo_city"
        fi

        echo ""
        echo "--- Summary ---"
        for world in hub lumo_wilds lumo_wilds_nether lumo_wilds_the_end lumo_city; do
          if world_exists $$world; then
            echo "✓ $$world"
          else
            echo "✗ $$world (not created)"
          fi
        done

        echo ""
        echo "World initialization complete!"
    networks:
      - minecraft-net
    restart: "no"

  rcon-web:
    image: itzg/rcon
    container_name: lumo-rcon-web
    ports:
      - "4326:4326"       # RCON Web UI
      - "4327:4327"       # WebSocket
    environment:
      RWA_USERNAME: admin
      RWA_PASSWORD: ${RCON_WEB_PASSWORD:-admin}
      RWA_ADMIN: "true"
      # Connection to Minecraft server
      RWA_RCON_HOST: minecraft
      RWA_RCON_PORT: 25575
      RWA_RCON_PASSWORD: ${RCON_PASSWORD:-minecraft}
    depends_on:
      - minecraft
    restart: unless-stopped
    networks:
      - minecraft-net

networks:
  minecraft-net:
    driver: bridge

volumes:
  minecraft-data:
